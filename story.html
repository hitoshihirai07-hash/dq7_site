<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>ストーリー</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />

</head>
<body>
<main>
  <div class="card">
    <h1>ストーリー</h1>

    <div class="toolbar">
      <input id="q" class="input" placeholder="検索（章 / 場所 / 目的 / メモ）" />
      <select id="era" class="select">
        <option value="all">時代: 全て</option>
        <option value="過去">過去</option>
        <option value="現代">現代</option>
      </select>
    </div>

    <div id="out" style="margin-top:12px;"></div>
  </div>
</main>

<footer>
  <div class="small"> </div>
</footer>

<script type="module">


  import { boot } from "./assets/app_common.js";
  import { loadCSV } from "./assets/data.js";
  import { qs, escapeHTML } from "./assets/util.js";

  boot("ストーリー | DQ7R");

  const Q = qs("#q");
  const ERA = qs("#era");
  const OUT = qs("#out");

  const PARAMS = new URLSearchParams(location.search);
  const QP = PARAMS.get("q") || "";
  const ERAP = PARAMS.get("era") || "";
  if (QP) Q.value = QP;
  if (ERAP) ERA.value = ERAP;


  const COLS = [
    { key:"era", label:"時代" },
    { key:"step_no", label:"手順" },
    { key:"location", label:"場所" },
    { key:"objective", label:"目的" },
    { key:"boss_id", label:"ボス" },
    { key:"notes", label:"メモ" },
  ];

  function norm(s){ return (s||"").toString().toLowerCase(); }

  function groupByChapter(rows){
    const m = new Map();
    for (const r of rows){
      const chap = (r.chapter || "（未分類）").toString().trim() || "（未分類）";
      if (!m.has(chap)) m.set(chap, []);
      m.get(chap).push(r);
    }
    for (const [_, arr] of m.entries()){
      arr.sort((a,b)=> Number(a.step_no||0) - Number(b.step_no||0));
    }
    return Array.from(m.entries()).sort((a,b)=> a[0].localeCompare(b[0], "ja"));
  }

  function makeTable(rows, bossNameById){
    const thead = `<thead><tr>${COLS.map(c=>`<th>${escapeHTML(c.label)}</th>`).join("")}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>{
      return `<tr>${COLS.map(c=>{
        if (c.key === "boss_id"){
          const bid = (r.boss_id || "").toString().trim();
          if (!bid) return `<td></td>`;
          const bname = bossNameById.get(bid) || "";
          if (!bname) return `<td><span class="small">（未登録）</span></td>`;
          return `<td><a href="./boss.html?id=${encodeURIComponent(bid)}">${escapeHTML(bname)}</a></td>`;
        }
        return `<td>${escapeHTML(r[c.key] ?? "")}</td>`;
      }).join("")}</tr>`;
    }).join("")}</tbody>`;
    return `<div class="table-wrap"><table>${thead}${tbody}</table></div>`;
  }

  async function main(){
    const [rows, bosses] = await Promise.all([
      loadCSV("./data/current/story_steps.csv"),
      loadCSV("./data/current/bosses.csv"),
    ]);

    const bossNameById = new Map(
      bosses.map(b=>[(b.boss_id||"").toString().trim(), (b.name||"").toString().trim()]).filter(x=>x[0])
    );

    function render(){
      const q = norm(Q.value.trim());
      const era = (ERA.value || "all").toString();

      const filtered = rows.filter(r=>{
        const rEra = (r.era || "").toString().trim();
        if (era !== "all" && rEra !== era) return false;

        if (!q) return true;

        const bid = (r.boss_id || "").toString().trim();
        const bname = bid ? (bossNameById.get(bid) || "") : "";
        const blob = [
          r.era, r.chapter, r.step_no, r.location, r.objective, r.notes, bname
        ].map(x=> (x||"").toString()).join(" ").toLowerCase();

        return blob.includes(q);
      });

      const grouped = groupByChapter(filtered);

      const quick = grouped.length
        ? `<div class="toolbar" style="margin:10px 0 12px;">
             <span class="small">章ジャンプ：</span>
             ${grouped.map(([chap, arr], i)=>`<a class="chip" href="#chap_${i}">${escapeHTML(chap)} (${arr.length})</a>`).join(" ")}
           </div>`
        : "";

      const blocks = grouped.map(([chap, arr], i)=>{
        const openAttr = (!q && i === 0) ? " open" : (q ? " open" : "");
        return `
          <details class="card" id="chap_${i}"${openAttr} style="margin-top:12px;">
            <summary style="cursor:pointer;">
              <b>${escapeHTML(chap)}</b>
              <span class="small" style="margin-left:8px;">(${arr.length})</span>
            </summary>
            <div style="margin-top:10px;">
              ${makeTable(arr, bossNameById)}
            </div>
          </details>
        `;
      }).join("");

      OUT.innerHTML = `
        <div class="small">表示件数: <b>${filtered.length}</b></div>
        ${quick}
        ${blocks || `<div class="small" style="margin-top:12px;">該当なし</div>`}
      `;
    }

    Q.addEventListener("input", render);
    ERA.addEventListener("change", render);
    render();
  }

  main().catch(err=>{
    OUT.innerHTML = `<div class="warn">${escapeHTML(err.message || String(err))}</div>`;
  });


</script>

</body>
</html>
