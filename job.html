<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>職業詳細</title>
</head>
<body>
<main>
  <div id="wrap" class="grid two"></div>
</main>

<footer>
  <div class="small"> </div>
</footer>
<script type="module">
  import { boot } from "./assets/app_common.js";
  import { loadCSV, byId } from "./assets/data.js";
  import { getParam, escapeHTML, makeTable } from "./assets/util.js";

  boot("職業詳細 | DQ7R");

  const id = getParam("id") || "";
  const WRAP = document.getElementById("wrap");

  function norm(s){ return (s||"").toLowerCase(); }

  async function main(){
    if (!id){
      WRAP.innerHTML = `<div class="card"><h1>職業詳細</h1><div class="warn">URLに <span class="mono">?id=job_001</span> のように指定してください。</div></div>`;
      return;
    }

    const [jobs, skills, jobSkills] = await Promise.all([
      loadCSV("./data/current/jobs.csv"),
      loadCSV("./data/current/skills.csv"),
      loadCSV("./data/current/job_skills.csv")
    ]);

    const job = byId(jobs, "job_id", id);
    if (!job){
      WRAP.innerHTML = `<div class="card"><h1>職業詳細</h1><div class="warn">job_id=${escapeHTML(id)} が見つかりません。</div><p><a href="./jobs.html">← 職業一覧へ</a></p></div>`;
      return;
    }

    document.title = `${job.name || job.job_id} | 職業詳細`;

    const skillById = new Map(skills.map(s=>[s.skill_id, s]));
    const learns = jobSkills
      .filter(js => (js.job_id||"") === id)
      .map(js=>{
        const sk = skillById.get(js.skill_id) || {};
        return {
          learn_condition: js.learn_condition || "",
          skill: sk.name || js.skill_id,
          type: sk.type || "",
          element: sk.element || "",
          target: sk.target || "",
          notes: (js.notes || sk.notes || "")
        };
      });

    const left = `
      <section class="card">
        <h1>${escapeHTML(job.name || "")}</h1>
        <div class="small mono">${escapeHTML(job.job_id || "")}</div>
        <p><b>分類：</b>${escapeHTML(job.group || "")}</p>
        <p><b>解放条件</b><br>${escapeHTML(job.unlock_condition || "")}</p>
        <p><b>職業とくせい</b><br>${escapeHTML(job.job_traits || "")}</p>
        <p><b>メモ</b><br>${escapeHTML(job.notes || "")}</p>
        <p class="small"><a href="./jobs.html">← 職業一覧へ戻る</a></p>
      </section>
    `;

    const cols = [
      { key:"learn_condition", label:"習得条件" },
      { key:"skill", label:"特技/呪文" },
      { key:"type", label:"種別" },
      { key:"element", label:"属性" },
      { key:"target", label:"対象" },
      { key:"notes", label:"メモ" }
    ];

    const right = `
      <section class="card">
        <h2>習得（特技/呪文）</h2>
        ${learns.length ? makeTable(learns, cols) : `<div class="warn">習得データがまだありません。</div>`}
      </section>
    `;

    WRAP.innerHTML = left + right;
  }

  main().catch(err=>{
    WRAP.innerHTML = `<div class="card"><h1>職業詳細</h1><div class="warn">${escapeHTML(err.message || String(err))}</div></div>`;
  });
</script>
</body>
</html>
