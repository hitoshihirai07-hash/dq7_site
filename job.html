<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>職業詳細</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />

</head>
<body>
<main>
  <div id="wrap" class="grid two"></div>
</main>

<footer>
  <div class="small"> </div>
</footer>
<script type="module">
  import { boot } from "./assets/app_common.js";
  import { loadCSV, byId } from "./assets/data.js";
  import { getParam, escapeHTML, makeTable } from "./assets/util.js";

  boot("職業詳細 | DQ7R");

  const id = getParam("id") || "";
  const WRAP = document.getElementById("wrap");

  function normalizePct_(v){
    const s = (v ?? "").toString().trim();
    if (!s) return "";
    if (s.endsWith("%")) return s;
    return s + "%";
  }

  function bonusRows_(job){
    const rows = [
      ["最大HP", normalizePct_(job.hp_pct)],
      ["最大MP", normalizePct_(job.mp_pct)],
      ["ちから", normalizePct_(job.str_pct)],
      ["みのまもり", normalizePct_(job.def_pct)],
      ["すばやさ", normalizePct_(job.agi_pct)],
      ["かしこさ", normalizePct_(job.int_pct)],
      ["かっこよさ", normalizePct_(job.charm_pct)],
    ].filter(r => r[1] !== "");
    return rows;
  }

  async function main(){
    if (!id){
      WRAP.innerHTML = `
        <div class="card">
          <h1>職業詳細</h1>
          <div class="small">URLに <span class="mono">?id=job_001</span> のように指定してください。</div>
          <p class="small"><a href="./jobs.html">← 職業一覧へ</a></p>
        </div>
      `;
      return;
    }

    const [jobs, skills, jobSkills] = await Promise.all([
      loadCSV("./data/current/jobs.csv"),
      loadCSV("./data/current/skills.csv"),
      loadCSV("./data/current/job_skills.csv"),
    ]);

    const job = byId(jobs, "job_id", id);
    if (!job){
      WRAP.innerHTML = `
        <div class="card">
          <h1>職業詳細</h1>
          <div class="warn">指定された職業が見つかりません。</div>
          <p class="small"><a href="./jobs.html">← 職業一覧へ</a></p>
        </div>
      `;
      return;
    }

    document.title = `${job.name || job.job_id} | 職業詳細`;

    const skillById = new Map(skills.map(s=>[s.skill_id, s]));
    const learns = jobSkills
      .filter(js => (js.job_id||"") === id)
      .map(js=>{
        const s = skillById.get(js.skill_id);
        return {
          sort: parseInt(js.sort_order || "9999", 10) || 9999,
          timing: js.timing || "",
          skill_id: js.skill_id || "",
          name: (s && s.name) ? s.name : (js.skill_id || ""),
          type: (s && s.type) ? s.type : "",
          notes: (s && s.notes) ? s.notes : ""
        };
      })
      .sort((a,b)=>a.sort-b.sort || a.name.localeCompare(b.name,"ja"));

    const learnCols = [
      { key:"timing", label:"段階" },
      {
        key:"name", label:"習得",
        render:(r)=> `<a href="./skill.html?id=${encodeURIComponent((r.skill_id||"").trim())}">${escapeHTML(r.name||"")}</a>`
      },
      { key:"type", label:"種別" },
      { key:"notes", label:"メモ" },
    ];

    const bRows = bonusRows_(job);
    const bonusHtml = bRows.length ? `
      <div class="card">
        <h2>ステータス補正（%）</h2>
        <div class="table-wrap">
          <table>
            <thead><tr><th>項目</th><th>補正</th></tr></thead>
            <tbody>
              ${bRows.map(r=>`<tr><td>${escapeHTML(r[0])}</td><td>${escapeHTML(r[1])}</td></tr>`).join("")}
            </tbody>
          </table>
        </div>
      </div>
    ` : "";

    WRAP.innerHTML = `
      <div class="card">
        <h1>${escapeHTML(job.name || "")}</h1>
        <div class="kv">
          <div><div class="k">系統</div><div class="v">${escapeHTML(job.group || "")}</div></div>
          <div><div class="k">条件</div><div class="v">${escapeHTML(job.unlock_condition || "")}</div></div>
          <div><div class="k">特性</div><div class="v">${escapeHTML(job.job_traits || "")}</div></div>
          <div><div class="k">メモ</div><div class="v">${escapeHTML(job.notes || "")}</div></div>
        </div>
        <p class="small"><a href="./jobs.html">← 職業一覧へ</a></p>
      </div>

      ${bonusHtml}

      <div class="card">
        <h2>習得（呪文・特技）</h2>
        ${makeTable(learns, learnCols)}
        <div class="small" style="margin-top:8px;">件数: ${learns.length}</div>
      </div>
    `;
  }

  main().catch(err=>{
    WRAP.innerHTML = `<div class="card"><h1>職業詳細</h1><div class="warn">${escapeHTML(err.message || String(err))}</div><p class="small"><a href="./jobs.html">← 職業一覧へ</a></p></div>`;
  });
</script>
</body>
</html>
