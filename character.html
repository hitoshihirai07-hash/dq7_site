<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>キャラクター詳細</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />

</head>
<body>
<main>
  <div id="wrap" class="grid two"></div>
</main>

<footer>
  <div class="small"> </div>
</footer>

<script type="module">

  import { boot } from "./assets/app_common.js";
  import { loadCSV, byId } from "./assets/data.js";
  import { getParam, escapeHTML, makeTable } from "./assets/util.js";

  boot("キャラクター詳細 | DQ7R");

  const id = getParam("id") || "";
  const WRAP = document.getElementById("wrap");

  async function main(){
    if (!id){
      WRAP.innerHTML = `<div class="card"><h1>キャラクター詳細</h1><div class="warn">URLに <span class="mono">?id=ch_001</span> のように指定してください。</div></div>`;
      return;
    }

    const [chars, skills, learns] = await Promise.all([
      loadCSV("./data/current/characters.csv"),
      loadCSV("./data/current/skills.csv"),
      loadCSV("./data/current/chara_learns.csv")
    ]);

    const ch = byId(chars, "chara_id", id);
    if (!ch){
      WRAP.innerHTML = `<div class="card"><h1>キャラクター詳細</h1><div class="warn">id=${escapeHTML(id)} が見つかりません。</div><p><a href="./characters.html">← キャラクター一覧へ</a></p></div>`;
      return;
    }

    document.title = `${ch.name || ch.chara_id} | キャラクター詳細`;

    const skillsById = new Map(skills.map(s=>[(s.skill_id||"").toString().trim(), s]).filter(x=>x[0]));
    const skillsByName = new Map();
    for (const s of skills){
      const n = (s.name||"").toString().trim();
      if (!n) continue;
      if (!skillsByName.has(n)) skillsByName.set(n, s);
    }

    
    const rows = learns
      .filter(x => (x.chara_id || "") === id)
      .map(x=>{
        const rawId = (x.skill_id || "").toString().trim();
        const rawName = (x.skill_name || x.name || "").toString().trim();

        let sk = null;
        if (rawId && skillsById.has(rawId)) sk = skillsById.get(rawId);
        else if (rawName && skillsByName.has(rawName)) sk = skillsByName.get(rawName);

        const sid = sk ? (sk.skill_id||"").toString().trim() : rawId;
        const name = rawName || (sk ? (sk.name||"").toString().trim() : "") || rawId;

        return {
          lv: x.learn_level || "",
          skill_id: sid,
          name,
          type: sk ? (sk.type||"") : "",
          element: sk ? (sk.element||"") : "",
          target: sk ? (sk.target||"") : "",
          notes: (x.notes || (sk ? (sk.notes||"") : "") || "")
        };
      })
      .filter(r=> (r.name||"").toString().trim())
      .sort((a,b)=> Number(a.lv||0) - Number(b.lv||0) || String(a.name).localeCompare(String(b.name),"ja"));
=> Number(a.lv||0) - Number(b.lv||0) || String(a.name).localeCompare(String(b.name),"ja"));

    const left = `
      <section class="card">
        <h1>${escapeHTML(ch.name || "")}</h1>
        <div class="small mono">${escapeHTML(ch.chara_id || "")}</div>
        <p><b>加入：</b>${escapeHTML(ch.join_chapter || "")}</p>
<p><b>概要</b><br>${escapeHTML(ch.profile_short || "")}</p>
        <p><b>メモ</b><br>${escapeHTML(ch.notes || "")}</p>
        <p class="small"><a href="./characters.html">← キャラクター一覧へ戻る</a></p>
      </section>
    `;

    const cols = [
      { key:"lv", label:"Lv" },
      { key:"name", label:"特技/呪文", render:(r)=>{ const n = escapeHTML(r.name||""); const sid = (r.skill_id||"").trim(); return sid ? `<a href="./skill.html?id=${encodeURIComponent(sid)}">${n}</a>` : n; } },
      { key:"type", label:"種別" },
      { key:"element", label:"属性" },
      { key:"target", label:"対象" },
      { key:"notes", label:"メモ" }
    ];

    const right = `
      <section class="card">
        <h2>Lvで覚える特技/呪文</h2>
        ${rows.length ? makeTable(rows, cols) : `<div class="warn">データがまだありません。</div>`}
      </section>
    `;

    WRAP.innerHTML = left + right;
  }

  main().catch(err=>{
    WRAP.innerHTML = `<div class="card"><h1>キャラクター詳細</h1><div class="warn">${escapeHTML(err.message || String(err))}</div></div>`;
  });

</script>
</body>
</html>
