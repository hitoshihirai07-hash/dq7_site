<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>職業</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />
  <meta name="description" content="DQ7R の職業一覧。検索・絞り込み対応。" />
</head>
<body>
<main>
  <div class="card">
    <h1>職業</h1>

    <p>職業を一覧表示します。検索で絞り込み、名前を押すと詳細ページに移動します。</p>
<p class="small">※非公式ファンサイトです。掲載情報は参考用です。</p>


    <div class="toolbar">
      <input id="q" class="input" placeholder="検索（名前 / 解放条件 / メモ）" />
      <select id="group">
        <option value="all">グループ：すべて</option>
      </select>
</div>

    <div id="out" style="margin-top:12px;"></div>
  </div>
</main>

<footer>
  <div class="footer-inner">
    <div class="footer-note">
      <div class="footer-links">
        <a href="./about.html">このサイトについて</a>
        <a href="./privacy.html">プライバシーポリシー</a>
        <a href="./contact.html">お問い合わせ</a>
      </div>
      <div class="small" style="margin-top:6px;">※非公式ファンサイトです。掲載情報は参考用です。</div>
    </div>
    <div class="footer-copy small">© 2026 DQ7R データベース</div>
  </div>
</footer>
<script type="module">
  import { boot } from "./assets/app_common.js";
  import { loadCSV } from "./assets/data.js";
  import { qs, escapeHTML, makeTable } from "./assets/util.js";

  boot("職業 | DQ7R");

  const Q = qs("#q");
  const GROUP = qs("#group");
  const OUT = qs("#out");

  const cols = [
    {
      key:"name",
      label:"職業",
      render:(r)=>{
        const id = (r.job_id || "").trim();
        const name = escapeHTML(r.name || "");
        return `<a href="./job.html?id=${encodeURIComponent(id)}">${name}</a>`;
      }
    },
    { key:"group", label:"系統" },
    { key:"unlock_condition", label:"条件" },
    {
      key:"bonus",
      label:"補正",
      render:(r)=> escapeHTML(formatBonus_(r))
    },
    { key:"job_traits", label:"特性" },
    { key:"notes", label:"メモ" },
  ];

  function norm(s){ return (s||"").toLowerCase(); }

  function formatBonus_(r){
    const pairs = [
      ["HP", r.hp_pct],
      ["MP", r.mp_pct],
      ["力", r.str_pct],
      ["守", r.def_pct],
      ["早", r.agi_pct],
      ["賢", r.int_pct],
      ["格", r.charm_pct],
    ].filter(([k,v]) => (v ?? "").toString().trim() !== "");

    if (!pairs.length) return "";

    return pairs.map(([k,v]) => `${k}${normalizePct_(v)}`).join(" ");
  }

  function normalizePct_(v){
    const s = (v ?? "").toString().trim();
    if (!s) return "";
    // allow "+10", "10", "-10", "+10%", "10%"
    if (s.endsWith("%")) return s;
    // keep + or -
    return s + "%";
  }

  async function main(){
    const jobs = await loadCSV("./data/current/jobs.csv");

    // group options
    const groups = Array.from(new Set(jobs.map(r=>(r.group||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b,"ja"));
    GROUP.innerHTML = `<option value="all">系統: 全て</option>` + groups.map(g=>`<option value="${escapeHTML(g)}">${escapeHTML(g)}</option>`).join("");

    function render(){
      const q = norm(Q.value.trim());
      const g = GROUP.value;

      const filtered = jobs.filter(r=>{
        if (g !== "all" && (r.group||"").trim() !== g) return false;
        if (!q) return true;
        const blob = [
          r.job_id,r.name,r.group,r.unlock_condition,r.job_traits,r.notes,
          r.hp_pct,r.mp_pct,r.str_pct,r.def_pct,r.agi_pct,r.int_pct,r.charm_pct
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });

      OUT.innerHTML = makeTable(filtered, cols) +
        `<div class="small" style="margin-top:8px;">件数: ${filtered.length}</div>`;
    }

    Q.addEventListener("input", render);
    GROUP.addEventListener("change", render);
    render();
  }

  main().catch(err=>{
    OUT.innerHTML = `<div class="warn">${escapeHTML(err.message || String(err))}</div>`;
  });
</script>
</body>
</html>
