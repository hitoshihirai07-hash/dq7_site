<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>呪文・特技</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />
</head>
<body>
<main>
  <section class="card">
    <h1>呪文・特技</h1>
    <div class="toolbar">
      <input id="q" class="input" placeholder="検索（名前 / 効果 / メモ）" />
      <select id="type" class="select">
        <option value="all">種別: 全て</option>
        <option value="特技">特技</option>
        <option value="呪文">呪文</option>
      </select>
      <select id="el" class="select">
        <option value="all">属性: 全て</option>
      </select>
    </div>
    <div id="out"></div>
  </section>
</main>

<footer><div> </div></footer>

<script type="module">
  import { boot } from "./assets/app_common.js";
  import { loadCSV } from "./assets/data.js";
  import { qs, escapeHTML } from "./assets/util.js";

  boot("呪文・特技 | DQ7R");

  const Q = qs("#q");
  const TYPE = qs("#type");
  const EL = qs("#el");
  const OUT = qs("#out");

  const COLS = [
    { key:"name", label:"名称" },
    { key:"type", label:"種別" },
    { key:"element", label:"属性" },
    { key:"target", label:"対象" },
    { key:"power", label:"効果量" },
    { key:"hit", label:"回数/命中" },
    { key:"notes", label:"メモ" },
  ];

  function norm(s){ return (s||"").toLowerCase(); }

  function renderTable(rows){
    const thead = `<thead><tr>${COLS.map(c=>`<th>${escapeHTML(c.label)}</th>`).join("")}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>{
      return `<tr>${COLS.map(c=>{
        if (c.key === "name"){
          const id = (r.skill_id||"").trim();
          const name = r.name || r.skill_id || "";
          return `<td><a href="./skill.html?id=${encodeURIComponent(id)}">${escapeHTML(name)}</a></td>`;
        }
        return `<td>${escapeHTML(r[c.key] ?? "")}</td>`;
      }).join("")}</tr>`;
    }).join("")}</tbody>`;
    return `<div class="table-wrap"><table>${thead}${tbody}</table></div>`;
  }

  async function main(){
    const skills = await loadCSV("./data/current/skills.csv");

    const els = Array.from(new Set(skills.map(r=>(r.element||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b,"ja"));
    EL.innerHTML = `<option value="all">属性: 全て</option>` + els.map(e=>`<option value="${escapeHTML(e)}">${escapeHTML(e)}</option>`).join("");

    function render(){
      const q = norm(Q.value.trim());
      const t = TYPE.value;
      const el = EL.value;

      const filtered = skills.filter(r=>{
        if (t !== "all" && (r.type||"").trim() !== t) return false;
        if (el !== "all" && (r.element||"").trim() !== el) return false;
        if (!q) return true;
        const blob = [r.name,r.notes,r.element,r.target,r.type].join(" ").toLowerCase();
        return blob.includes(q);
      });

      OUT.innerHTML = `${renderTable(filtered)}
        <div class="small" style="margin-top:10px;">件数: ${filtered.length}</div>`;
    }

    Q.addEventListener("input", render);
    TYPE.addEventListener("change", render);
    EL.addEventListener("change", render);
    render();
  }

  main().catch(err=>{
    OUT.innerHTML = `<div class="warn">${escapeHTML(err.message || String(err))}</div>`;
  });
</script>
</body>
</html>
