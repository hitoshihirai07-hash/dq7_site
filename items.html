<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>アイテム</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />  <meta name="description" content="DQ7R のアイテム一覧。検索・絞り込み対応。" />
</head>
<body>
<main>
  <section class="card">
    <h1>アイテム</h1>

    <p>アイテムを一覧表示します。カテゴリ・入手メモなどの検索で絞り込みできます。</p>
<p class="small">※非公式ファンサイトです。掲載情報は参考用です。</p>

    <div class="toolbar">
      <input id="q" class="input" placeholder="検索（名前 / 効果 / メモ）" />
      <select id="cat" class="select">
        <option value="all">カテゴリ: 全て</option>
      </select>
    </div>
    <div id="out"></div>
  </section>
</main>

<footer>
  <div class="footer-inner">
    <div class="footer-note">
      <div class="footer-links">
        <a href="./about.html">このサイトについて</a>
        <a href="./privacy.html">プライバシーポリシー</a>
        <a href="./contact.html">お問い合わせ</a>
      </div>
      <div class="small" style="margin-top:6px;">※非公式ファンサイトです。掲載情報は参考用です。</div>
    </div>
    <div class="footer-copy small">© 2026 DQ7R データベース</div>
  </div>
</footer>

<script type="module">
  import { boot } from "./assets/app_common.js";
  import { loadCSV } from "./assets/data.js";
  import { qs, escapeHTML } from "./assets/util.js";

  boot("アイテム | DQ7R");

  const Q = qs("#q");
  const CAT = qs("#cat");
  const OUT = qs("#out");

  const COLS = [
    { key:"name", label:"名前" },
    { key:"category", label:"カテゴリ" },
    { key:"slot", label:"部位/種別" },
    { key:"atk", label:"攻撃" },
    { key:"def", label:"防御" },
    { key:"price_buy", label:"買値" },
    { key:"price_sell", label:"売値" },
    { key:"effect", label:"効果" },
  ];

  function norm(s){ return (s||"").toLowerCase(); }

  function renderTable(rows){
    const thead = `<thead><tr>${COLS.map(c=>`<th>${escapeHTML(c.label)}</th>`).join("")}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>{
      return `<tr>${COLS.map(c=>{
        if (c.key === "name"){
          const id = (r.item_id||"").trim();
          const name = r.name || r.item_id || "";
          {
          const sub = [];
          if ((r.era||"").trim()) sub.push(`時代: ${escapeHTML(r.era)}`);
          if ((r.obtain||"").trim()) sub.push(`入手: ${escapeHTML(r.obtain)}`);
          const subHtml = sub.length ? `<div class="small">${sub.join(" / ")}</div>` : ``;
          return `<td><a href="./item.html?id=${encodeURIComponent(id)}">${escapeHTML(name)}</a>${subHtml}</td>`;
        }
        }
        return `<td>${escapeHTML(r[c.key] ?? "")}</td>`;
      }).join("")}</tr>`;
    }).join("")}</tbody>`;
    return `<div class="table-wrap"><table>${thead}${tbody}</table></div>`;
  }

  async function main(){
    const items = await loadCSV("./data/current/items.csv");

    // build category options
    const cats = Array.from(new Set(items.map(r=>(r.category||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b,"ja"));
    CAT.innerHTML = `<option value="all">カテゴリ: 全て</option>` + cats.map(c=>`<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("");

    function render(){
      const q = norm(Q.value.trim());
      const cat = CAT.value;

      const filtered = items.filter(r=>{
        if (cat !== "all" && (r.category||"").trim() !== cat) return false;
        if (!q) return true;
        const blob = [r.name,r.effect,r.notes,r.category,r.slot,r.era,r.obtain].join(" ").toLowerCase();
        return blob.includes(q);
      });

      OUT.innerHTML = `${renderTable(filtered)}
        <div class="small" style="margin-top:10px;">件数: ${filtered.length}</div>`;
    }

    Q.addEventListener("input", render);
    CAT.addEventListener("change", render);
    render();
  }

  main().catch(err=>{
    OUT.innerHTML = `<div class="warn">${escapeHTML(err.message || String(err))}</div>`;
  });
</script>
</body>
</html>
