<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <title>呪文・特技詳細</title>

  <link rel="icon" href="./assets/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#e8892f" />  <meta name="description" content="DQ7R の特技詳細ページ。" />
</head>
<body>
<main>
<div class="card" style="margin-bottom:12px;"><h1 style="margin-bottom:6px;">特技詳細</h1><p>特技の詳細情報を表示します。URLの <span class="mono">?id=</span> を指定すると該当ページを開けます。</p><p class="small">※非公式ファンサイトです。掲載情報は参考用です。</p></div>
  <div id="wrap" class="grid two"></div>
</main>

<footer>
  <div class="footer-inner">
    <div class="footer-note">
      <div class="footer-links">
        <a href="./about.html">このサイトについて</a>
        <a href="./privacy.html">プライバシーポリシー</a>
        <a href="./contact.html">お問い合わせ</a>
      </div>
      <div class="small" style="margin-top:6px;">※非公式ファンサイトです。掲載情報は参考用です。</div>
    </div>
    <div class="footer-copy small">© 2026 DQ7R データベース</div>
  </div>
</footer>

<script type="module">
  import { boot } from "./assets/app_common.js";
  import { loadCSV, byId } from "./assets/data.js";
  import { getParam, escapeHTML } from "./assets/util.js";

  boot("呪文・特技詳細 | DQ7R");

  const id = getParam("id") || "";
  const WRAP = document.getElementById("wrap");

  function listCard(title, rows){
    if (!rows.length) return `<div class="card"><h2>${escapeHTML(title)}</h2><div class="warn">なし</div></div>`;
    return `<div class="card"><h2>${escapeHTML(title)}</h2>
      <ul class="list">
        ${rows.map(x=>`<li>${escapeHTML(x)}</li>`).join("")}
      </ul>
    </div>`;
  }

  async function main(){
    if (!id){
      WRAP.innerHTML = `<div class="card"><h1>呪文・特技詳細</h1><div class="warn">URLに <span class="mono">?id=skill_001</span> のように指定してください。</div><p><a href="./skills.html">← 呪文・特技一覧へ</a></p></div>`;
      return;
    }

    const [skills, jobs, jobSkills, chars, charaLearns] = await Promise.all([
      loadCSV("./data/current/skills.csv"),
      loadCSV("./data/current/jobs.csv"),
      loadCSV("./data/current/job_skills.csv"),
      loadCSV("./data/current/characters.csv"),
      loadCSV("./data/current/chara_learns.csv"),
    ]);

    const s = byId(skills, "skill_id", id);
    if (!s){
      WRAP.innerHTML = `<div class="card"><h1>呪文・特技詳細</h1><div class="warn">id=${escapeHTML(id)} が見つかりません。</div><p><a href="./skills.html">← 呪文・特技一覧へ</a></p></div>`;
      return;
    }

    document.title = `${s.name || s.skill_id} | 呪文・特技詳細`;

    const jobById = new Map(jobs.map(j=>[j.job_id, j]));
    const charById = new Map(chars.map(c=>[c.chara_id, c]));

    const learnedByJobs = jobSkills
      .filter(r=>(r.skill_id||"")===id)
      .map(r=>{
        const j = jobById.get(r.job_id) || {};
        const name = j.name || r.job_id || "";
        const cond = (r.learn_condition||"").trim();
        return cond ? `${name}（${cond}）` : name;
      });

    const learnedByChars = charaLearns
      .filter(r=>(r.skill_id||"")===id)
      .map(r=>{
        const c = charById.get(r.chara_id) || {};
        const name = c.name || r.chara_id || "";
        const lv = (r.learn_level||"").trim();
        return lv ? `${name}（Lv${lv}）` : name;
      });

    const left = `
      <section class="card">
        <h1>${escapeHTML(s.name || "")}</h1>
        <div class="small mono">${escapeHTML(s.skill_id || "")}</div>

        <p>
          <b>種別：</b>${escapeHTML(s.type || "")}<br>
          <b>属性：</b>${escapeHTML(s.element || "")}<br>
          <b>対象：</b>${escapeHTML(s.target || "")}
        </p>

        <p>
          <b>効果量：</b>${escapeHTML(s.power || "")}<br>
          <b>回数/命中：</b>${escapeHTML(s.hit || "")}
        </p>

        <p><b>メモ</b><br>${escapeHTML(s.notes || "")}</p>

        <p class="small"><a href="${(s.type||"").trim()==="呪文" ? "./spells.html" : "./skills.html"}">← 一覧へ戻る</a></p>
      </section>
    `;

    const right = `
      <section class="grid">
        ${listCard("習得：職業", learnedByJobs)}
        ${listCard("習得：キャラクター", learnedByChars)}
      </section>
    `;

    WRAP.innerHTML = left + right;
  }

  main().catch(err=>{
    WRAP.innerHTML = `<div class="card"><h1>呪文・特技詳細</h1><div class="warn">${escapeHTML(err.message || String(err))}</div><p><a href="./skills.html">← 呪文・特技一覧へ</a></p></div>`;
  });
</script>
</body>
</html>